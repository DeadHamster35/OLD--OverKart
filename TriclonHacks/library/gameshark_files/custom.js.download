function showModal(action, postdata){
	$.ajax({
		type: "POST",
		url: "/inc/sub." + action + ".php",
		data: postdata
	})
		.done(function( msg ) {
			$(".modal-content").html(msg);
			$("#modalWindow").modal("show");
		});
}

function submitForm(action, title = "Message"){
	var formData = new FormData($("#" + action)[0]);
	$.ajax({
		type: "POST",
		url: "/inc/sub." + action + ".php",
		data: formData,
		contentType: false,
		processData: false
	})
		.done(function( msg ) {
			if(msg)
				showModal("message", { msgTitle: title, msgBody: msg });
			else
				location.reload();
		});
}

// Game

function fillGroup(postdata){
	if($("#Group" + postdata['grpID']).hasClass('in')){
		$("#Group" + postdata['grpID']).collapse('hide');
		return false;
	}

	$.ajax({
		type: "POST",
		url: "/modules/game.php",
		data: postdata
	})
		.done(function( msg ) {
			$("#Group" + postdata['grpID']).html(msg);
			$("#Group" + postdata['grpID']).collapse('show');
		});
}

function showCodeInfo(postdata, toggle){
	if (toggle == null) toggle = true;
	if(toggle && $("#CodeInfo" + postdata['codID']).hasClass('in')){
		$("#CodeInfo" + postdata['codID']).collapse('hide');
		$("#Code" + postdata['codID'] + " .codControl .collapsed").removeClass('glyphicon-chevron-up');
		$("#Code" + postdata['codID'] + " .codControl .collapsed").addClass('glyphicon-chevron-down');
	} else
		$.ajax({
			type: "POST",
			url: "/inc/sub.codeInfo.php",
			data: postdata
		})
			.done(function( msg ) {
				$("#CodeInfo" + postdata['codID']).html(msg);
				if(toggle){
					$("#CodeInfo" + postdata['codID']).collapse('show');
					$("#Code" + postdata['codID'] + " .codControl .collapsed").removeClass('glyphicon-chevron-down');
					$("#Code" + postdata['codID'] + " .codControl .collapsed").addClass('glyphicon-chevron-up');
				}
			});
}

function updateCodeInfo(postdata){
	$.ajax({
		type: "POST",
		url: "/inc/sub.codeInfo.php",
		data: postdata
	})
		.done(function( msg ) {
			$(".modal-content").html(msg);
		});
}

function cloneNewCode(panel){
	//remove chosens
	$('.chosen-container').remove();
	$('.chosen-select').css({display: "inline-block"}).removeClass("chosen-done");
	$('.chosen-select').removeData("chosen");

	//clone
	newcode = $(panel).clone(true);

	//copy hackers
	$(".codHackers option:selected", panel).each(function(){
		$(".codHackers option:eq("+$(this).index()+")", newcode).prop('selected', true);
	});

	//copy group
	$(".codGroup", newcode).val($(".codGroup", panel).val());

	//copy format
	$(".codFormat", newcode).val($(".codFormat", panel).val());

	//copy encrypted
	$(".codEnc", newcode).val($(".codEnc", panel).val());

	//append
	$('#addCode').append(newcode);

	//init chosens
	$('.chosen-select').chosen({width:"100%"});

	checkMinuses();
}

function checkMinuses(){
	if($("#addCode").children(".panel").length == 1)
		$("#addCode .panel-heading .glyphicon-minus").css("display", "none");
	else
		$("#addCode .panel-heading .glyphicon-minus").css("display", "block");
}

// Converter

function crypt(system) {
	$.ajax({
		type: "POST",
		url: "/inc/inc.converter.php",
		data: { 
			sys: system,
			from: $("#format").val(), 
			code: $("#convert-code").val(), 
			encrypted: $("#encrypted").prop("checked") ? "true" : "false"
		}
	})
		.done(function( msg ) {
			$("#return").html(msg); 
		});
}

function gettypes(system) {
	$.ajax({
		type: "POST",
		url: "/inc/inc.converter.php",
		data: { 
			sys: system,
			device: $("#format").val()
		}
	})
		.done(function( msg ) {
			$("#convert-types").html(msg);
			if(msg.substr(0,4) != "This")
				getparts(system);
		});
}

function getparts(system) {
	$.ajax({
		type: "POST",
		url: "/inc/inc.converter.php",
		data: { 
			sys: system,
			format: $("#format").val(), 
			codetype: $("#type").val(), 
			encrypted: $("#encrypted").prop("checked") ? "true" : "false"
		}
	})
		.done(function( msg ) {
			$("#convert-parts").html(msg);
		});
}

function addcodeline() {
	var enc = $("#encrypted").prop("checked") ? "true" : "false";
	$.ajax({
		type: "POST",
		url: "/inc/inc.converter.php",
		data: $("#addLineForm").serialize() + "&encrypted=" + enc + "&format=" + $("#format").val()
	})
		.done(function( msg ) {
			if($("#convert-code").val().length == 0)
				msg = msg.substr(1);
			$("#convert-code").val($("#convert-code").val()+msg); 
		});
}

function gameSearch(f) {
	var system = $("#game-system").val();
	var query = $("#game-query").val();
	window.location.href = "/system/" + system + "/" + query;
	return false;
}